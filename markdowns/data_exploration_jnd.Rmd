---
title: "Explore Data"
author: "Jody Daniel"
date: "`r Sys.Date()`"
output: 
 markdowntemplates::bulma:
    highlight: tango
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(readxl)
library(stringi)
library(stringr)
library(vegan)
library(writexl)
library(ggthemes)
library(ggrepel)
library(viridis)
library(ggforce)
library(sda)
library(sysfonts)
library(viridis)
library(RColorBrewer)
source(paste0(here::here(), "/scripts/functions.R"))
```

# Background

Need to do work on congruence between birds and plants - not able to do fish as we did not collected at the same plots. The data for birds are `r paste0(here::here(), "data/bird_matrix.csv")`. Need to prepare the plant data, however.

# Data Preparation
For plants, we have the total number trees, by DBH, in each plot - associated with each DBH catgeory, we have the canopy width and tree height. From this ifnormation, we can measure relative density of each species in each plot. We can also get a mean/median and max height for each species present. Thus, I will create 3 sepertae files:

* Basal Area - the total area of each species in a plot. Using a representative tree, we find the basal area (p*r^2, where r = DBH/2) and multiple this value by total number of trees. Because the DBH categories were within categories, we will use the median value in each interval. We repeat this for each DBH category and sum by species.
* Mean Canopy Width - we find the mean of canopy width of trees for by species. 
* Mean Tree Height - we find the weighted mean of tree height of of trees for by species. 

Following, because we merged some plots for our bird analyses because of their proximity to other plots, we fill average these values across plot groups. This is what we will use for the congruence analsyes.

```{r prepare data, message=FALSE, error=FALSE, warning=FALSE}
VegDataRaw <- read_excel(paste0(here::here(),
                                "/data/Bird and Veg Data - complete and validated.xlsx"), sheet = "Plants") %>%
  rename(SiteName = Site)%>%
  mutate(SiteCode = case_when(SiteName == "Westerhall" ~ "WH",
                            SiteName == "Conference" ~ "CN",
                            SiteName == "Levera" ~ "LV",
                            SiteName == "Mt. Hartman" ~ "MH"),
         SiteID = paste0(SiteCode, "-", "T", Transect, "-",  "P", Plot )) %>%
  relocate(SiteCode, .after = SiteName)%>%
  relocate(SiteID, .after = SiteName)%>%
  filter(!is.na(SiteName))%>%
  mutate(SiteType = ifelse(SiteName %in% c("Westerhall", "Mt. Hartman"), "Fringe", "Basin"))%>%
   relocate(SiteType, .after = SiteName)%>%
  left_join(read_excel(paste0(here::here(),
                                "/data/Bird and Veg Data - complete and validated.xlsx"), 
                       sheet = "Site Info") %>%
              rename(`SiteID`= "Site ID")%>%
              rename(SiteName = "Area"))%>%
  relocate(Independent, .after = "SiteName") %>%
  relocate(SiteID, .after = "SiteName") %>%
  relocate(Longitude, .before = "Date")%>%
  relocate(Latitude, .before = "Date")

BirdData <- VegDataRaw %>% select(SiteName, SiteID, SiteType, Independent)%>%
  right_join(read_excel(paste0(here::here(),
                                "/data/Bird and Veg Data - complete and validated.xlsx"), sheet = "Birds")%>%
  rename(SiteName = "Site")%>%
  mutate(SiteCode = case_when(SiteName == "Westerhall" ~ "WH",
                            SiteName == "Conference" ~ "CN",
                            SiteName == "Levera" ~ "LV",
                            SiteName == "Mt. Hartman" ~ "MH"),
         SiteID = paste0(SiteCode, "-", "T", Transect, "-",  "P", Plot ))) %>%
 # filter(!SiteName=="Conference" & `Visit Number` == 3)%>% # drop one visit for conference
  group_by(SiteName, SiteType, Independent, Species) %>%
  summarise(Abundance = (mean(Abundance, na.rm = TRUE)) %>% round())%>%
  pivot_wider(names_from  = "Species",
              values_from = "Abundance",
              values_fill = 0)%>% filter(!is.na(SiteName))%>%
  mutate(Independent = paste0(Independent, "-", "0"))



BirdDataSumSiteID <-  VegDataRaw %>% select(SiteName, SiteID, SiteType, Independent)%>%
  right_join(read_excel(paste0(here::here(),
                                "/data/Bird and Veg Data - complete and validated.xlsx"), sheet = "Birds")%>%
  rename(SiteName = "Site")%>%
  mutate(SiteCode = case_when(SiteName == "Westerhall" ~ "WH",
                            SiteName == "Conference" ~ "CN",
                            SiteName == "Levera" ~ "LV",
                            SiteName == "Mt. Hartman" ~ "MH"),
         SiteID = paste0(SiteCode, "-", "T", Transect, "-",  "P", Plot ))) %>%
 # filter(!SiteName=="Conference" & `Visit Number` == 3)%>% # drop one visit for conference
  group_by(SiteName, SiteType, SiteID, Independent, Date, Species) %>%
  summarise(Abundance = (sum(Abundance, na.rm = TRUE)) %>% round())%>%
  pivot_wider(names_from  = "Species",
              values_from = "Abundance",
              values_fill = 0)%>% filter(!is.na(SiteName))%>%
  group_by(Independent)%>%
  mutate(Independent = paste0(Independent, "-", row_number()))

BirdDataOG <-  VegDataRaw %>% select(SiteName, SiteID, SiteType, Independent)%>%
  right_join(read_excel(paste0(here::here(),
                                "/data/Bird and Veg Data - complete and validated.xlsx"), sheet = "Birds")%>%
  rename(SiteName = "Site")%>%
  mutate(SiteCode = case_when(SiteName == "Westerhall" ~ "WH",
                            SiteName == "Conference" ~ "CN",
                            SiteName == "Levera" ~ "LV",
                            SiteName == "Mt. Hartman" ~ "MH"),
         SiteID = paste0(SiteCode, "-", "T", Transect, "-",  "P", Plot ))) %>%
 # filter(!SiteName=="Conference" & `Visit Number` == 3)%>% # drop one visit for conference
  group_by(SiteName, SiteType, SiteID, Independent, Species) %>%
  summarise(Abundance = (sum(Abundance, na.rm = TRUE)) %>% round())%>%
  pivot_wider(names_from  = "Species",
              values_from = "Abundance",
              values_fill = 0)%>% filter(!is.na(SiteName))%>%
  group_by(Independent)%>%
  mutate(Independent = paste0(Independent, "-", row_number())) %>% ungroup()
  
BirdTraits <-
  BirdDataSumSiteID %>% ungroup()%>% select(SiteName, SiteType, SiteID)%>% distinct()%>%
  arrange(SiteID)%>%
  bind_cols( 
    map_dfc(.x = c("Food", "Behaviour",  "Nesting", "Habitat","Type"), ~{
  BirdDataSumSiteID %>%
    arrange(SiteID)%>% ungroup() %>%
    select(SiteID, 
           ANCH:SHCO) %>%
    pivot_longer(!SiteID, names_to = "Code",
                 values_to = "Abundance")%>%
    left_join(read_csv(paste0(here::here(),
                              "/data/bird_traits_raw.csv")))%>% 
                select(SiteID, !!sym(.x),Abundance)%>%
                                                  group_by(SiteID,
                                                           !!sym(.x))%>%
                                                  summarise(Abundance = round(mean(Abundance)))%>%
                                                  filter(!is.na(!!sym(.x)))%>%
                                                  pivot_wider(names_from = .x,
                                                              values_from = "Abundance")%>%
        
                                                  arrange(SiteID) %>% ungroup()%>% select(-SiteID)
  }))


BirdTraitsOG <-
  BirdDataOG %>% ungroup()%>% select(SiteName, SiteType, SiteID)%>% distinct()%>%
  arrange(SiteID)%>%
  bind_cols( 
    map_dfc(.x = c("Food", "Behaviour",  "Nesting", "Habitat","Type"), ~{
  BirdDataOG %>%
    arrange(SiteID)%>% ungroup() %>%
    select(SiteID, 
           ANCH:SHCO) %>%
    pivot_longer(!SiteID, names_to = "Code",
                 values_to = "Abundance")%>%
    left_join(read_csv(paste0(here::here(),
                              "/data/bird_traits_raw.csv")))%>% 
                select(SiteID, !!sym(.x),Abundance)%>%
                                                  group_by(SiteID,
                                                           !!sym(.x))%>%
                                                  summarise(Abundance = round(mean(Abundance)))%>%
                                                  filter(!is.na(!!sym(.x)))%>%
                                                  pivot_wider(names_from = .x,
                                                              values_from = "Abundance")%>%
        
                                                  arrange(SiteID) %>% ungroup()%>% select(-SiteID)
  }))
  
```

```{r message=FALSE, error=FALSE, warning=FALSE}
VegDatLong <- VegDataRaw %>%
  select(contains(c("Site", "Independent", "_T_")))%>%
  pivot_longer(cols = contains("_T_"),
               names_to = c("Species", "Circumference"),
               names_pattern = "(.*)_T_(.*)",
               values_to = "Total") %>%
  left_join(VegDataRaw %>%
  select(contains(c("Site", "Independent", "_TH_")))%>%
  pivot_longer(cols = contains("_TH_"),
               names_to = c("Species", "Circumference"),
               names_pattern = "(.*)_TH_(.*)",
               values_to = "Tree Height")) %>%
  left_join(VegDataRaw %>%
  select(contains(c("Site", "Independent", "_CW_")))%>%
  pivot_longer(cols = contains("_CW_"),
               names_to = c("Species", "Circumference"),
               names_pattern = "(.*)_CW_(.*)",
               values_to = "Canopy Width")) %>%
  mutate(DBHRange = case_when(Circumference == "0-3.18" ~ "0-10",
                         Circumference == "3.19-7.96" ~ "10-25",
                         Circumference == "7.98-31.82" ~ "25-100",
                         Circumference == "31.83-63.65" ~ "100-200",
                         Circumference == ">63" ~ ">200"))%>%
  mutate(DBHMin = ifelse(stringr::str_detect(DBHRange, ">"), 200, 
                         (stringr::str_remove(DBHRange, "-.*"))) %>% as.numeric(),
         DBHMax = ifelse(stringr::str_detect(DBHRange, ">"), NA_real_, 
                         (stringr::str_remove(DBHRange, ".*-"))) %>% as.numeric()) %>%
  rowwise()%>%
  mutate(DBH = ifelse(DBHMin == 200, 200, median(c(DBHMax, DBHMin))))%>%
  ungroup()%>%
  mutate(`Basal Area (m^2)` = (3.142 * (DBH/2 * 0.001)) * Total)
  
```

# Site Summary

First, we compare vegetation cover by site and type.
We see that the Conference and Levera, which are the basine mangroves, both have larger and taller trees. 

```{r site summary, echo=FALSE}
VegDatLong %>%
  group_by(SiteName)%>%
  summarise(BasalAreaMean = mean(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0]),
            BasalAreaSD = sd(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0]),
            CanopyWidthMean = mean(`Canopy Width`[`Canopy Width`!= 0]),
            CanopyWidthSD = sd(`Canopy Width`[`Canopy Width`!= 0]),
            HeightMean = mean(`Tree Height`[`Tree Height`!= 0]),
            HeightSD = sd(`Tree Height`[`Tree Height`!= 0]))

VegDatLong %>%
  group_by(SiteType)%>%
  summarise(BasalAreaMean = mean(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0]),
            BasalAreaSD = sd(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0]),
            CanopyWidthMean = mean(`Canopy Width`[`Canopy Width`!= 0]),
            CanopyWidthSD = sd(`Canopy Width`[`Canopy Width`!= 0]),
            HeightMean = mean(`Tree Height`[`Tree Height`!= 0]),
            HeightSD = sd(`Tree Height`[`Tree Height`!= 0]))


```


```{r vegmatrix prep, message=FALSE, error=FALSE, warning=FALSE}

VegMatrixSiteID <-
  VegDatLong %>% group_by(SiteName, SiteType, SiteID, Species) %>%
  summarise(BasalArea = mean(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "BasalArea") %>%
  rename(`RedBasalArea` = "Red")%>%
   rename(`BlackBasalArea` = "Black") %>%
   rename(`WhiteBasalArea` = "White")%>%
  left_join(VegDatLong %>% group_by(SiteName, SiteType, SiteID, Species) %>%
  summarise(CanopyWidth = mean(`Canopy Width`[`Canopy Width`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "CanopyWidth") %>%
  rename(`RedCanopyWidth` = "Red")%>%
   rename(`BlackCanopyWidth` = "Black") %>%
   rename(`WhiteCanopyWidth` = "White"))%>%
  left_join(VegDatLong %>% group_by(SiteName, SiteType, SiteID, Species) %>%
  summarise(TreeHeight = mean(`Tree Height`[`Tree Height`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "TreeHeight") %>%
  rename(`RedTreeHeight` = "Red")%>%
   rename(`BlackTreeHeight` = "Black") %>%
   rename(`WhiteTreeHeight` = "White"))%>%
  mutate(across(.cols = everything(), ~ ifelse(is.infinite(.x), 0, .x)))%>%
  mutate(across(.cols = everything(), ~ ifelse(is.na(.x), 0, .x)))
  

VegMatrixIndependent <-
  VegDatLong %>%  group_by(SiteName, SiteType, Independent, Species) %>%
  summarise(BasalArea = mean(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "BasalArea") %>%
  rename(`RedBasalArea` = "Red")%>%
   rename(`BlackBasalArea` = "Black") %>%
   rename(`WhiteBasalArea` = "White")%>%
  left_join(VegDatLong %>% group_by(SiteName, SiteType, Independent, Species) %>%
  summarise(CanopyWidth = mean(`Canopy Width`[`Canopy Width`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "CanopyWidth") %>%
  rename(`RedCanopyWidth` = "Red")%>%
   rename(`BlackCanopyWidth` = "Black") %>%
   rename(`WhiteCanopyWidth` = "White"))%>%
  left_join(VegDatLong %>% group_by(SiteName, SiteType, Independent, Species) %>%
  summarise(TreeHeight = mean(`Tree Height`[`Tree Height`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "TreeHeight") %>%
  rename(`RedTreeHeight` = "Red")%>%
   rename(`BlackTreeHeight` = "Black") %>%
   rename(`WhiteTreeHeight` = "White")) %>% filter(!is.na(Independent))%>%
  mutate(across(.cols = everything(), ~ ifelse(is.infinite(.x), 0, .x)))%>%
  mutate(across(.cols = everything(), ~ ifelse(is.na(.x), 0, .x)))

```

# Congruence

One big question is whether composition of birds and plants covary. Below, we use Mantel test and Procustes analsyes to evaluate if composition covaries. We will use both the raw data, by plot and the plots that are combined. 


```{r message=FALSE, error=FALSE, warning=FALSE}



TreeHeightBird <- 
  CongruenceCrossTaxon(DataVeg = VegMatrixSiteID%>% 
                         rename(Independent = SiteID) %>% filter(Independent %in% BirdDataOG$SiteID), 
                       BirdDataOG %>% select(-Independent)%>% rename(Independent = SiteID), 
                       ColTraitVeg = "TreeHeight") %>% arrange(Test)

TreeHeightBirdID <- 
  CongruenceCrossTaxon(VegMatrixIndependent, 
                       BirdData,   
                       ColTraitVeg = "TreeHeight") %>% arrange(Test)

BasalAreaBird <- 
  CongruenceCrossTaxon(VegMatrixSiteID%>% 
                         rename(Independent = SiteID) %>% filter(Independent %in% BirdDataOG$SiteID), 
                       BirdDataOG %>% select(-Independent)%>% rename(Independent = SiteID), 
                       ColTraitVeg = "BasalArea") %>% arrange(Test)

BasalAreaBirdID <- 
  CongruenceCrossTaxon(VegMatrixIndependent, 
                       BirdData, 
                       ColTraitVeg = "BasalArea") %>% arrange(Test)

CanopyWidthBird <- 
  CongruenceCrossTaxon(VegMatrixSiteID%>% 
                         rename(Independent = SiteID) %>% filter(Independent %in% BirdDataOG$SiteID), 
                       BirdDataOG %>% select(-Independent)%>% rename(Independent = SiteID), 
                       ColTraitVeg = "CanopyWidth") %>% arrange(Test)

CanopyWidthBirdID <- 
  CongruenceCrossTaxon(VegMatrixIndependent, 
                       BirdData, 
                       ColTraitVeg = "CanopyWidth") %>% arrange(Test)

```


As we see below, we get confilciting results when we use the combined data versus the raw data. This may be because we lack power to detcted an effect when the combine plots, and also because the plant compoisition varies amoung plots that are combined.




```{r view congruence mantel, echo=FALSE}


plot(TreeHeightBird %>% filter(Test == "Mantel" & Group %in% c("Overall", "Basin", "Fringe"))%>% 
       mutate(Type = "Tree Height")%>%
bind_rows(BasalAreaBird %>% filter(Test == "Mantel" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Basal Area")) %>%
 bind_rows(CanopyWidthBird %>% filter(Test == "Mantel" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Canopy Width"))%>%
  mutate(Significance = case_when(`P-Value`<0.001 ~ "***",
                                  `P-Value`<0.05 ~ "**",
                                  `P-Value`<0.1 ~ "*",
                                  TRUE ~ ""))%>%
 ggplot(aes(x = Type, y = Strength, fill = Group))+
  geom_bar(stat = "identity", position = "dodge")+
  scale_fill_brewer(palette = "BrBG")+
  geom_text(aes(label = Significance), size = 6, position = position_dodge(width = .9))+
    theme_gaea()+
  labs( y = "Strength of Cross-Taxon Congruence (r)",
        x = " ", fill = "",
        caption = "Birds & Plants\nMantel Test\nRaw Data"))

plot(TreeHeightBirdID %>% filter(Test == "Mantel" & Group %in% c("Overall", "Basin", "Fringe"))%>% 
       mutate(Type = "Tree Height")%>%
bind_rows(BasalAreaBirdID %>% filter(Test == "Mantel" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Basal Area")) %>%
 bind_rows(CanopyWidthBirdID %>% filter(Test == "Mantel" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Canopy Width"))%>%
  mutate(Significance = case_when(`P-Value`<0.001 ~ "***",
                                  `P-Value`<0.05 ~ "**",
                                  `P-Value`<0.1 ~ "*",
                                  TRUE ~ ""))%>%
 ggplot(aes(x = Type, y = Strength, fill = Group))+
  geom_bar(stat = "identity", position = "dodge")+
  scale_fill_brewer(palette = "BrBG")+
  geom_text(aes(label = Significance), size = 6, position = position_dodge(width = .9))+
    theme_gaea()+
  labs( y = "Strength of Cross-Taxon Congruence (r)",
        x = " ", fill = "",
        caption = "Birds & Plants\nMantel Test\nCombined Data"))


```



```{r view congruence Procustes, echo=FALSE}


plot(TreeHeightBird %>% filter(Test == "Procustes" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Tree Height")%>%
bind_rows(BasalAreaBird %>% filter(Test == "Procustes" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Basal Area")) %>%
 bind_rows(CanopyWidthBird %>% filter(Test == "Procustes" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Canopy Width"))%>%
  mutate(Significance = case_when(`P-Value`<0.001 ~ "***",
                                  `P-Value`<0.05 ~ "**",
                                  `P-Value`<0.1 ~ "*",
                                  TRUE ~ ""))%>%
  ggplot(aes(x = Type, y = Strength, fill = Group))+
  geom_bar(stat = "identity", position = "dodge")+
  scale_fill_brewer(palette = "BrBG")+
  geom_text(aes(label = Significance), size = 6, position = position_dodge(width = .9))+
    theme_gaea()+
  labs( y = expression(paste("Strength of Cross-Taxon Congruence (", m^2, ")")),
        x = " ", fill = "",
        caption = "Birds & Plants\nProcustes Analysis\nRaw Data"))

plot(TreeHeightBirdID %>% filter(Test == "Procustes" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Tree Height")%>%
bind_rows(BasalAreaBirdID %>% filter(Test == "Procustes" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Basal Area")) %>%
 bind_rows(CanopyWidthBirdID %>% filter(Test == "Procustes" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Canopy Width"))%>%
  mutate(Significance = case_when(`P-Value`<0.001 ~ "***",
                                  `P-Value`<0.05 ~ "**",
                                  `P-Value`<0.1 ~ "*",
                                  TRUE ~ ""))%>%
  ggplot(aes(x = Type, y = Strength, fill = Group))+
  geom_bar(stat = "identity", position = "dodge")+
  scale_fill_brewer(palette = "BrBG")+
  geom_text(aes(label = Significance), size = 6, position = position_dodge(width = .9))+
    theme_gaea()+
  labs( y = expression(paste("Strength of Cross-Taxon Congruence (", m^2, ")")),
        x = " ", fill = "",
        caption = "Birds & Plants\nProcustes Analysis\nCombined Data"))


```





```{r export congruence,  message=FALSE, error=FALSE, warning=FALSE}
png(paste0(here::here(), "/outputs/PlantBirdCongruenceMantel.png"),
    units = "in",
    res = 600, width = 8, height = 5)
plot(TreeHeightBirdID %>% filter(Test == "Mantel" & Group %in% c("Overall", "Basin", "Fringe"))%>% 
       mutate(Type = "Tree Height")%>%
bind_rows(BasalAreaBirdID %>% filter(Test == "Mantel" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Basal Area")) %>%
 bind_rows(CanopyWidthBirdID %>% filter(Test == "Mantel" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Canopy Width"))%>%
  mutate(Significance = case_when(`P-Value`<0.001 ~ "***",
                                  `P-Value`<0.05 ~ "**",
                                  `P-Value`<0.1 ~ "*",
                                  TRUE ~ ""))%>%
 ggplot(aes(x = Type, y = Strength, fill = Group))+
  geom_bar(stat = "identity", position = "dodge")+
  scale_fill_brewer(palette = "BrBG")+
  geom_text(aes(label = Significance), size = 6, position = position_dodge(width = .9))+
    theme_gaea()+
  labs( y = "Strength of Cross-Taxon Congruence (r)",
        x = " ", fill = "",
        caption = "Birds & Plants\nMantel Test"))
dev.off()

png(paste0(here::here(), "/outputs/PlantBirdCongruenceProcustes.png"),
    units = "in",
    res = 600, width = 8, height = 5)
plot(TreeHeightBird %>% filter(Test == "Procustes" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Tree Height")%>%
bind_rows(BasalAreaBird %>% filter(Test == "Procustes" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Basal Area")) %>%
 bind_rows(CanopyWidthBird %>% filter(Test == "Procustes" & Group %in% c("Overall", "Basin", "Fringe"))%>% mutate(Type = "Canopy Width"))%>%
  mutate(Significance = case_when(`P-Value`<0.001 ~ "***",
                                  `P-Value`<0.05 ~ "**",
                                  `P-Value`<0.1 ~ "*",
                                  TRUE ~ ""))%>%
  ggplot(aes(x = Type, y = Strength, fill = Group))+
  geom_bar(stat = "identity", position = "dodge")+
  scale_fill_brewer(palette = "BrBG")+
  geom_text(aes(label = Significance), size = 6, position = position_dodge(width = .9))+
    theme_gaea()+
  labs( y = expression(paste("Strength of Cross-Taxon Congruence (", m^2, ")")),
        x = " ", fill = "",
        caption = "Birds & Plants\nProcustes Analysis"))
dev.off()
  
```


# Visulizing Communtiy Composiiton

Now, we can take a look at community composition using NMDSs for plants and look at how they might relate to the birds at the sites. After determining how many axis we need, which are 2, we can run our NMDS. 

```{r nmds numebr of axis, include=FALSE}
BasalAreaAxis <- 
NMDS.ScreePoints(data = VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("BasalArea")),
                 noRuns = 50)
CanopyWidthAxis <- 
NMDS.ScreePoints(data = VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("CanopyWidth")),
                 noRuns = 50)
TreeHeightAxis <- 
NMDS.ScreePoints(data = VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("TreeHeight")),
                 noRuns = 50)

```


```{r view nmds axis, message=FALSE, error=FALSE, warning=FALSE}
BasalAreaAxis  %>% t() %>% data.frame()%>%
  mutate(Run = factor(1:50))%>% 
  pivot_longer(!Run,
               names_to = c("NoAxis"),
               names_pattern = "X(.*)",
               values_to = "Stress")%>%
  group_by(NoAxis) %>%
  summarise(Stress = mean(Stress))%>%
  ungroup()%>%
  mutate(NoAxis = factor(as.numeric(as.character(NoAxis))))%>%
  ggplot(aes(x = NoAxis, y = Stress))+
  geom_line(aes(group = 1), size = 1)+
  theme_bw()
CanopyWidthAxis  %>% t() %>% data.frame()%>%
  mutate(Run = factor(1:50))%>% 
  pivot_longer(!Run,
               names_to = c("NoAxis"),
               names_pattern = "X(.*)",
               values_to = "Stress")%>%
  group_by(NoAxis) %>%
  summarise(Stress = mean(Stress))%>%
  ungroup()%>%
  mutate(NoAxis = factor(as.numeric(as.character(NoAxis))))%>%
  ggplot(aes(x = NoAxis, y = Stress))+
  geom_line(aes(group = 1), size = 1)+
  theme_bw()
TreeHeightAxis  %>% t() %>% data.frame()%>%
  mutate(Run = factor(1:50))%>% 
  pivot_longer(!Run,
               names_to = c("NoAxis"),
               names_pattern = "X(.*)",
               values_to = "Stress")%>%
  group_by(NoAxis) %>%
  summarise(Stress = mean(Stress))%>%
  ungroup()%>%
  mutate(NoAxis = factor(as.numeric(as.character(NoAxis))))%>%
  ggplot(aes(x = NoAxis, y = Stress))+
  geom_line(aes(group = 1), size = 1)+
  theme_gaea()
```


```{r run nmds, include=FALSE}



TreeHeightSiteIDNMS <- metaMDS(VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("TreeHeight")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)
BasalAreaSiteIDNMS <- metaMDS(VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("BasalArea")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)
CanopyWidthSiteIDNMS <- metaMDS(VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("CanopyWidth")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)

TreeHeightIndependentNMS <- metaMDS(VegMatrixIndependent %>% arrange(Independent)%>% 
                   ungroup() %>%select(contains("TreeHeight")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)
BasalAreaIndependentNMS <- metaMDS(VegMatrixIndependent %>% arrange(Independent)%>% 
                   ungroup() %>%select(contains("BasalArea")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)
CanopyWidthIndependentNMS <- metaMDS(VegMatrixIndependent %>% arrange(Independent)%>% 
                   ungroup() %>%select(contains("CanopyWidth")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)

```


```{r save the plots, include = FALSE, message=FALSE, error=FALSE, warning=FALSE}
BirdsSiteNMS <- metaMDS(BirdData %>% ungroup() %>% select(ANCH:SHCO) ,  distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-Combined",
                 DataX =  BirdData,
                 Choices = c(1:2),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Site")
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-Combined",
                 DataX =  BirdData,
                 Choices = c(1:2),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Type")

BirdsSiteNMS <- metaMDS(BirdDataOG %>% ungroup() %>% select(ANCH:SHCO) ,  distance = "bray",
                                 k = 3, autotransform = TRUE,trymax=100)
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-OG",
                 DataX =  BirdDataOG,
                 Choices = c(1:3),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Site")
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-OG",
                 DataX =  BirdDataOG,
                 Choices = c(1:3),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Type")

BirdsSiteNMS <- metaMDS(BirdDataSumSiteID %>% ungroup() %>% select(ANCH:SHCO) ,  distance = "bray",
                                 k = 3, autotransform = TRUE,trymax=100)
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-OG-Date-Sum",
                 DataX =  BirdDataSumSiteID,
                 Choices = c(1:3),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Site")
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-OG-Date-Sum",
                 DataX =  BirdDataSumSiteID,
                 Choices = c(1:3),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Type")

BirdsPlantsNMDSSitePlots <-
  NMDSPlotsBirdsPlants(NMDSList = list(`Basal Area`= (BasalAreaIndependentNMS),
                                     `Canopy Width`= CanopyWidthIndependentNMS,
                                     `Tree Height`= TreeHeightIndependentNMS),
                     DataX = BirdDataSum,
                     DataY = list(BirdDataSum, BirdDataSum),
                     Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                     Type = "Site")
PlantsNMDSSitePlots <-
NMDSPlotsPlants(NMDSList = list(`Basal Area`= (BasalAreaSiteIDNMS),
                                     `Canopy Width`= CanopyWidthSiteIDNMS,
                                     `Tree Height`= TreeHeightSiteIDNMS),
                     DataX = VegMatrixSiteID,
                     Type = "Site")

BirdsPlantsNMDSTypePlots <-
  NMDSPlotsBirdsPlants(NMDSList = list(`Basal Area`= (BasalAreaIndependentNMS),
                                     `Canopy Width`= CanopyWidthIndependentNMS,
                                     `Tree Height`= TreeHeightIndependentNMS),
                     DataX = VegMatrixIndependent,
                     DataY = list(BirdDataSum, BirdDataSum),
                     Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                     Type = "Type")

PlantsNMDSTypePlots <-
NMDSPlotsPlants(NMDSList = list(`Basal Area`= (BasalAreaSiteIDNMS),
                                     `Canopy Width`= CanopyWidthSiteIDNMS,
                                     `Tree Height`= TreeHeightSiteIDNMS),
                     DataX = VegMatrixSiteID,
                     Type = "Type")

```

# Dispersion

## Birds

```{r permanova birds, message=FALSE, error=FALSE, warning=FALSE}

DispersionResults(DataX = BirdDataOG %>%  
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "Birds", groups = c("SiteName", "SiteType"))
DispersionPlots(DataX = BirdDataOG %>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "Birds", groups = c("SiteName", "SiteType"))



```

## Birds

```{r permanova birds traits, message=FALSE, error=FALSE, warning=FALSE}

  
    
DispersionResults(DataX = BirdTraitsOG%>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "Traits", groups = c("SiteName", "SiteType"))
DispersionPlots(DataX = BirdTraitsOG%>% 
                 # mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                  mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")),
                DataType = "Traits", groups = c("SiteName", "SiteType"))




```


## Plants

### Basal Area

```{r permanova BasalArea, message=FALSE, error=FALSE, warning=FALSE}

DispersionResults(DataX = VegMatrixSiteID%>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "BasalArea", groups = c("SiteName", "SiteType"))
DispersionPlots(DataX = VegMatrixSiteID%>% 
                  #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                  mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")),
                DataType = "BasalArea", groups = c("SiteName", "SiteType"))



```



```{r permanova CanopyWidth, message=FALSE, error=FALSE, warning=FALSE}

DispersionResults(DataX = VegMatrixSiteID%>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "CanopyWidth", groups = c("SiteName", "SiteType"))
DispersionPlots(DataX = VegMatrixSiteID%>% 
                  #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                  mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")),
                DataType = "CanopyWidth", groups = c("SiteName", "SiteType"))



```

### Tree Height

```{r permanova TreeHeight, message=FALSE, error=FALSE, warning=FALSE}

DispersionResults(DataX = VegMatrixSiteID%>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "TreeHeight", groups = c("SiteName", "SiteType"))
DispersionPlots(DataX = VegMatrixSiteID%>% 
                  #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                  mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")),
                DataType = "TreeHeight", groups = c("SiteName", "SiteType"))



```

### Canopy Width

```{r permanova CanopyWidth, message=FALSE, error=FALSE, warning=FALSE}

DispersionResults(DataX = VegMatrixSiteID%>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "CanopyWidth", groups = c("SiteName", "SiteType"))
DispersionPlots(DataX = VegMatrixSiteID%>% 
                  #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                  mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")),
                DataType = "CanopyWidth", groups = c("SiteName", "SiteType"))



```


```{r}
png(paste0(here::here(), "/outputs/PlantCanopyWidthSpecies.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteName", "CanopyWidth")))%>%
  pivot_longer(!SiteName)%>%
  mutate(Label = str_remove_all(name, "CanopyWidth"))%>%
  ggplot(aes(x = SiteName, y = value, fill = Label))+
  geom_point(position = position_jitterdodge(), aes(color = Label), alpha = 0.3)+
  geom_boxplot(outlier.shape = NA)+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site", y = "Canopy Width (m)")+
  theme(legend.position = "bottom")

dev.off()

png(paste0(here::here(), "/outputs/PlantCanopyWidthSpeciesType.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteType", "CanopyWidth")))%>%
  pivot_longer(!SiteType)%>%
  mutate(Label = str_remove_all(name, "CanopyWidth"))%>%
  ggplot(aes(x = SiteType, y = value, fill = Label))+
  geom_point(position = position_jitterdodge(), aes(color = Label), alpha = 0.3)+
  geom_boxplot(outlier.shape = NA)+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site Type", y = "Canopy Width (m)")+
  theme(legend.position = "bottom")

dev.off()

png(paste0(here::here(), "/outputs/PlantCanopyWidthSite.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteName", "CanopyWidth")))%>%
  pivot_longer(!SiteName)%>%
  mutate(Label = str_remove_all(name, "CanopyWidth"))%>%
  ggplot(aes(x = SiteName, y = value))+
  geom_point(alpha = 0.3)+
  geom_boxplot(outlier.shape = NA)+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site", y = "Canopy Width (m)")+
  theme(legend.position = "bottom")

dev.off()


png(paste0(here::here(), "/outputs/PlantCanopyWidthSiteType.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteType", "CanopyWidth")))%>%
  pivot_longer(!SiteType)%>%
  mutate(Label = str_remove_all(name, "CanopyWidth"))%>%
  ggplot(aes(x = SiteType, y = value))+
  geom_point(alpha = 0.3)+
  geom_boxplot(outlier.shape = NA)+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site Type", y = "Canopy Width (m)")+
  theme(legend.position = "bottom")

dev.off()
```



```{r}
png(paste0(here::here(), "/outputs/PlantBasalAreaSpecies.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteName", "BasalArea")))%>%
  pivot_longer(!SiteName)%>%
  mutate(Label = str_remove_all(name, "BasalArea"))%>%
  ggplot(aes(x = SiteName, y = value, fill = Label))+
  geom_point(position = position_jitterdodge(), aes(color = Label), alpha = 0.3)+
  geom_boxplot(outlier.shape = NA)+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site", y = "Basal Area (m\u00b2)")+
  theme(legend.position = "bottom")

dev.off()


png(paste0(here::here(), "/outputs/PlantBasalAreaSite.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteName", "BasalArea")))%>%
  pivot_longer(!SiteName)%>%
  mutate(Label = str_remove_all(name, "BasalArea"))%>%
  ggplot(aes(x = SiteName, y = value))+
  geom_point(alpha = 0.3)+
  geom_boxplot(outlier.shape = NA)+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site", y = "Basal Area (m\u00b2)")+
  theme(legend.position = "bottom")

dev.off()


png(paste0(here::here(), "/outputs/PlantBasalAreaSpeciesType.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteType", "BasalArea")))%>%
  pivot_longer(!SiteType)%>%
  mutate(Label = str_remove_all(name, "BasalArea"))%>%
  ggplot(aes(x = SiteType, y = value, fill = Label))+
  geom_point(position = position_jitterdodge(), aes(color = Label), alpha = 0.3)+
  geom_boxplot(outlier.shape = NA)+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site Type", y = "Basal Area (m\u00b2)")+
  theme(legend.position = "bottom")

dev.off()


png(paste0(here::here(), "/outputs/PlantBasalAreaSiteType.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteType", "BasalArea")))%>%
  pivot_longer(!SiteType)%>%
  mutate(Label = str_remove_all(name, "BasalArea"))%>%
  ggplot(aes(x = SiteType, y = value))+
  geom_point(alpha = 0.3)+
  geom_boxplot(outlier.shape = NA)+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site Type", y = "Basal Area (m\u00b2)")+
  theme(legend.position = "bottom")

dev.off()
```

```{r}
png(paste0(here::here(), "/outputs/PlantBasalAreaSpeciesViolin.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteName", "BasalArea")))%>%
  pivot_longer(!SiteName)%>%
  mutate(Label = str_remove_all(name, "BasalArea"))%>%
  ggplot(aes(x = SiteName, y = value, fill = Label, color = Label))+
  geom_point(position = position_jitterdodge(), aes(color = Label), alpha = 0.3)+
  geom_violin()+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site", y = "Basal Area (m\u00b2)")+
  theme(legend.position = "bottom")

dev.off()


png(paste0(here::here(), "/outputs/PlantBasalAreaSiteViolin.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteName", "BasalArea")))%>%
  pivot_longer(!SiteName)%>%
  mutate(Label = str_remove_all(name, "BasalArea"))%>%
  ggplot(aes(x = SiteName, y = value))+
  geom_violin(color = "grey50", fill = "grey50")+
  geom_point(alpha = 0.3)+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site", y = "Basal Area (m\u00b2)")+
  theme(legend.position = "bottom")

dev.off()


png(paste0(here::here(), "/outputs/PlantBasalAreaSpeciesViolinType.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteType", "BasalArea")))%>%
  pivot_longer(!SiteType)%>%
  mutate(Label = str_remove_all(name, "BasalArea"))%>%
  ggplot(aes(x = SiteType, y = value, fill = Label, color = Label))+
  geom_point(position = position_jitterdodge(), aes(color = Label), alpha = 0.3)+
  geom_violin()+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site Type", y = "Basal Area (m\u00b2)")+
  theme(legend.position = "bottom")

dev.off()


png(paste0(here::here(), "/outputs/PlantBasalAreaSiteViolinType.png"),
    units = "in",
    res = 600, width = 6, height = 4)
VegMatrixSiteID %>%
  ungroup()%>%
  select(contains(c("SiteType", "BasalArea")))%>%
  pivot_longer(!SiteType)%>%
  mutate(Label = str_remove_all(name, "BasalArea"))%>%
  ggplot(aes(x = SiteType, y = value))+
  geom_violin(color = "grey50", fill = "grey50")+
  geom_point(alpha = 0.3)+
  theme_bw()+
  scale_colour_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  labs(color = " ", fill = " ", 
       x = "Site Type", y = "Basal Area (m\u00b2)")+
  theme(legend.position = "bottom")

dev.off()
```



```{r message=FALSE, error=FALSE, warning=FALSE}
write_xlsx(x = list(`Plants - Independent (Mean)` = VegMatrixIndependent,
                    `Plants - SiteID (Mean)` = VegMatrixSiteID,
                    `Birds - Mean by Independent` = BirdData,
                    `Birds - Sum by Independent` = BirdDataSum,
                     `Birds - Sum by Date & Independent` = BirdDatDateSum),
           path = paste0(here::here(), "/data/DataFromCongruenceAnalyses.xlsx"))
```
