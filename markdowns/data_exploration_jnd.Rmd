---
title: "Explore Data"
author: "Jody Daniel"
date: "`r Sys.Date()`"
output: 
 markdowntemplates::bulma:
    highlight: tango
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(readxl)
library(stringi)
library(stringr)
library(vegan)
library(writexl)
library(ggthemes)
library(ggrepel)
library(viridis)
library(ggforce)
library(sda)
library(sysfonts)
library(viridis)
library(RColorBrewer)
source(paste0(here::here(), "/scripts/functions.R"))
```

# Background

Need to do work on congruence between birds and plants - not able to do fish as we did not collected at the same plots. The data for birds are `r paste0(here::here(), "data/bird_matrix.csv")`. Need to prepare the plant data, however.

# Data Preparation
For plants, we have the total number trees, by DBH, in each plot - associated with each DBH catgeory, we have the canopy width and tree height. From this ifnormation, we can measure relative density of each species in each plot. We can also get a mean/median and max height for each species present. Thus, I will create 3 sepertae files:

* Basal Area - the total area of each species in a plot. Using a representative tree, we find the basal area (p*r^2, where r = DBH/2) and multiple this value by total number of trees. Because the DBH categories were within categories, we will use the median value in each interval. We repeat this for each DBH category and sum by species.
* Mean Canopy Width - we find the mean of canopy width of trees for by species. 
* Mean Tree Height - we find the weighted mean of tree height of of trees for by species. 

Following, because we merged some plots for our bird analyses because of their proximity to other plots, we fill average these values across plot groups. This is what we will use for the congruence analsyes.

```{r prepare data, message=FALSE, error=FALSE, warning=FALSE}
VegDataRaw <- read_excel(paste0(here::here(),
                                "/data/Bird and Veg Data - complete and validated.xlsx"), sheet = "Plants") %>%
  rename(SiteName = Site)%>%
  mutate(SiteCode = case_when(SiteName == "Westerhall" ~ "WH",
                            SiteName == "Conference" ~ "CN",
                            SiteName == "Levera" ~ "LV",
                            SiteName == "Mt. Hartman" ~ "MH"),
         SiteID = paste0(SiteCode, "-", "T", Transect, "-",  "P", Plot )) %>%
  relocate(SiteCode, .after = SiteName)%>%
  relocate(SiteID, .after = SiteName)%>%
  filter(!is.na(SiteName))%>%
  mutate(SiteType = ifelse(SiteName %in% c("Westerhall", "Mt. Hartman"), "Fringe", "Basin"))%>%
   relocate(SiteType, .after = SiteName)%>%
  left_join(read_excel(paste0(here::here(),
                                "/data/Bird and Veg Data - complete and validated.xlsx"), 
                       sheet = "Site Info") %>%
              rename(`SiteID`= "Site ID")%>%
              rename(SiteName = "Area"))%>%
  relocate(Independent, .after = "SiteName") %>%
  relocate(SiteID, .after = "SiteName") %>%
  relocate(Longitude, .before = "Date")%>%
  relocate(Latitude, .before = "Date")

BirdData <- VegDataRaw %>% select(SiteName, SiteID, SiteType, Independent)%>%
  right_join(read_excel(paste0(here::here(),
                                "/data/Bird and Veg Data - complete and validated.xlsx"), sheet = "Birds")%>%
  rename(SiteName = "Site")%>%
  mutate(SiteCode = case_when(SiteName == "Westerhall" ~ "WH",
                            SiteName == "Conference" ~ "CN",
                            SiteName == "Levera" ~ "LV",
                            SiteName == "Mt. Hartman" ~ "MH"),
         SiteID = paste0(SiteCode, "-", "T", Transect, "-",  "P", Plot ))) %>%
  arrange(Species)%>%
 # filter(!SiteName=="Conference" & `Visit Number` == 3)%>% # drop one visit for conference
  group_by(SiteName, SiteType, Independent, Species) %>%
  summarise(Abundance = (mean(Abundance, na.rm = TRUE)) %>% round())%>%
  pivot_wider(names_from  = "Species",
              values_from = "Abundance",names_sort = TRUE,
              values_fill = 0)%>% filter(!is.na(SiteName))%>%
  mutate(Independent = paste0(Independent, "-", "0"))



BirdDataSumSiteID <-  VegDataRaw %>% select(SiteName, SiteID, SiteType, Independent)%>%
  right_join(read_excel(paste0(here::here(),
                                "/data/Bird and Veg Data - complete and validated.xlsx"), sheet = "Birds")%>%
  rename(SiteName = "Site")%>%
  mutate(SiteCode = case_when(SiteName == "Westerhall" ~ "WH",
                            SiteName == "Conference" ~ "CN",
                            SiteName == "Levera" ~ "LV",
                            SiteName == "Mt. Hartman" ~ "MH"),
         SiteID = paste0(SiteCode, "-", "T", Transect, "-",  "P", Plot ))) %>%
 # filter(!SiteName=="Conference" & `Visit Number` == 3)%>% # drop one visit for conference
  arrange(Species)%>%
  group_by(SiteName, SiteType, SiteID, Independent, Date, Species) %>%
  summarise(Abundance = (sum(Abundance, na.rm = TRUE)) %>% round())%>%
  pivot_wider(names_from  = "Species",
              values_from = "Abundance", names_sort = TRUE,
              values_fill = 0)%>% filter(!is.na(SiteName))%>%
  group_by(Independent)%>%
  mutate(Independent = paste0(Independent, "-", row_number()))

BirdDataOG <-  VegDataRaw %>% select(SiteName, SiteID, SiteType, Independent)%>%
  right_join(read_excel(paste0(here::here(),
                                "/data/Bird and Veg Data - complete and validated.xlsx"), sheet = "Birds")%>%
  rename(SiteName = "Site")%>%
  mutate(SiteCode = case_when(SiteName == "Westerhall" ~ "WH",
                            SiteName == "Conference" ~ "CN",
                            SiteName == "Levera" ~ "LV",
                            SiteName == "Mt. Hartman" ~ "MH"),
         SiteID = paste0(SiteCode, "-", "T", Transect, "-",  "P", Plot ))) %>%
 # filter(!SiteName=="Conference" & `Visit Number` == 3)%>% # drop one visit for conference
  group_by(SiteName, SiteType, SiteID, Independent, Species) %>%
  arrange(Species)%>%
  summarise(Abundance = (sum(Abundance, na.rm = TRUE)) %>% round())%>%
  pivot_wider(names_from  = "Species",
              values_from = "Abundance",names_sort = TRUE,
              values_fill = 0)%>% filter(!is.na(SiteName))%>%
  group_by(Independent)%>%
  mutate(Independent = paste0(Independent, "-", row_number())) %>% ungroup()
  
BirdTraits <-
  BirdDataSumSiteID %>% ungroup()%>% select(SiteName, SiteType, SiteID)%>% distinct()%>%
  arrange(SiteID)%>%
  bind_cols( 
    map_dfc(.x = c("Food", "Behaviour",  "Nesting", "Habitat","Type"), ~{
  BirdDataSumSiteID %>%
    arrange(SiteID)%>% ungroup() %>%
    select(SiteID, 
           ANCH:ZEND) %>%
    pivot_longer(!SiteID, names_to = "Code",
                 values_to = "Abundance")%>%
    left_join(read_csv(paste0(here::here(),
                              "/data/bird_traits_raw.csv")))%>% 
                select(SiteID, !!sym(.x),Abundance)%>%
                                                  group_by(SiteID,
                                                           !!sym(.x))%>%
                                                  summarise(Abundance = round(mean(Abundance)))%>%
                                                  filter(!is.na(!!sym(.x)))%>%
                                                  pivot_wider(names_from = .x,
                                                              values_from = "Abundance")%>%
        
                                                  arrange(SiteID) %>% ungroup()%>% select(-SiteID)
  }))



BirdTraitsSpecies <-
  read_csv(paste0(here::here(),
                "/data/bird_traits_raw.csv")) %>% select(Code) %>% arrange(Code)%>%
  bind_cols(
 map_dfc(.x = c("Food", "Behaviour",  "Nesting", "Habitat","Type"), ~{
  Save <- 
    read_csv(paste0(here::here(),
                "/data/bird_traits_raw.csv")) %>% group_by(Code, !!sym(.x)) %>% tally() %>% arrange(Code) %>% pivot_wider(id_cols = Code, names_from = !!sym(.x), values_from = n)%>% replace(is.na(.), 0) %>% arrange(Code)%>%
    ungroup()
  
   Name <- Save %>% colnames()
   Saver <- !str_detect(Save %>% colnames(), "NA")
   
  Saver <- Name[Saver]
  
  Save %>% select(all_of(Saver)) %>% select(!Code)
  }))


BirdTraitsOG <-
  BirdDataOG %>% ungroup()%>% select(SiteName, SiteType, SiteID)%>% distinct()%>%
  arrange(SiteID)%>%
  bind_cols( 
    map_dfc(.x = c("Food", "Behaviour",  "Nesting", "Habitat","Type"), ~{
  BirdDataOG %>%
    arrange(SiteID)%>% ungroup() %>%
    select(SiteID, 
           ANCH:ZEND) %>%
    pivot_longer(!SiteID, names_to = "Code",
                 values_to = "Abundance")%>%
    left_join(read_csv(paste0(here::here(),
                              "/data/bird_traits_raw.csv")))%>% 
                select(SiteID, !!sym(.x),Abundance)%>%
                                                  group_by(SiteID,
                                                           !!sym(.x))%>%
                                                  summarise(Abundance = round(mean(Abundance)))%>%
                                                  filter(!is.na(!!sym(.x)))%>%
                                                  pivot_wider(names_from = .x,
                                                              values_from = "Abundance")%>%
        
                                                  arrange(SiteID) %>% ungroup()%>% select(-SiteID)
  }))

BirdTraitsIndependent <- 
  BirdTraits %>% left_join(VegDataRaw %>% select(SiteName, SiteID, SiteType, Independent)) %>% relocate(Independent, .after = SiteType) %>% ungroup() %>% select(Independent, `Aquatic invertebrates`:Resident) %>% group_by(Independent) %>% summarise(across(`Aquatic invertebrates`:Resident, ~sum(.x, na.rm = TRUE)))

BirdTraitMatrix <- 
  BirdTraitsIndependent %>% mutate(across(`Aquatic invertebrates`:Resident, ~ifelse(.x>=1,1,0)))
  
```

```{r message=FALSE, error=FALSE, warning=FALSE}
VegDatLong <- VegDataRaw %>%
  select(contains(c("Site", "Independent", "_T_")))%>%
  pivot_longer(cols = contains("_T_"),
               names_to = c("Species", "Circumference"),
               names_pattern = "(.*)_T_(.*)",
               values_to = "Total") %>%
  left_join(VegDataRaw %>%
  select(contains(c("Site", "Independent", "_TH_")))%>%
  pivot_longer(cols = contains("_TH_"),
               names_to = c("Species", "Circumference"),
               names_pattern = "(.*)_TH_(.*)",
               values_to = "Tree Height")) %>%
  left_join(VegDataRaw %>%
  select(contains(c("Site", "Independent", "_CW_")))%>%
  pivot_longer(cols = contains("_CW_"),
               names_to = c("Species", "Circumference"),
               names_pattern = "(.*)_CW_(.*)",
               values_to = "Canopy Width")) %>%
  mutate(DBHRange = case_when(Circumference == "0-3.18" ~ "0-10",
                         Circumference == "3.19-7.96" ~ "10-25",
                         Circumference == "7.98-31.82" ~ "25-100",
                         Circumference == "31.83-63.65" ~ "100-200",
                         Circumference == ">63" ~ ">200"))%>%
  mutate(DBHMin = ifelse(stringr::str_detect(DBHRange, ">"), 200, 
                         (stringr::str_remove(DBHRange, "-.*"))) %>% as.numeric(),
         DBHMax = ifelse(stringr::str_detect(DBHRange, ">"), NA_real_, 
                         (stringr::str_remove(DBHRange, ".*-"))) %>% as.numeric()) %>%
  rowwise()%>%
  mutate(DBH = ifelse(DBHMin == 200, 200, median(c(DBHMax, DBHMin))))%>%
  ungroup()%>%
  mutate(`Basal Area (m^2)` = (3.142 * (DBH/2 * 0.001)) * Total)
  
```

# Site Summary

First, we compare vegetation cover by site and type.
We see that the Conference and Levera, which are the basine mangroves, both have larger and taller trees. 

```{r site summary, echo=FALSE}
VegDatLong %>%
  group_by(SiteName)%>%
  summarise(BasalAreaMean = mean(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0]),
            BasalAreaSD = sd(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0]),
            CanopyWidthMean = mean(`Canopy Width`[`Canopy Width`!= 0]),
            CanopyWidthSD = sd(`Canopy Width`[`Canopy Width`!= 0]),
            HeightMean = mean(`Tree Height`[`Tree Height`!= 0]),
            HeightSD = sd(`Tree Height`[`Tree Height`!= 0]))

VegDatLong %>%
  group_by(SiteType)%>%
  summarise(BasalAreaMean = mean(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0]),
            BasalAreaSD = sd(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0]),
            CanopyWidthMean = mean(`Canopy Width`[`Canopy Width`!= 0]),
            CanopyWidthSD = sd(`Canopy Width`[`Canopy Width`!= 0]),
            HeightMean = mean(`Tree Height`[`Tree Height`!= 0]),
            HeightSD = sd(`Tree Height`[`Tree Height`!= 0]))


```


```{r vegmatrix prep, message=FALSE, error=FALSE, warning=FALSE}

VegMatrixSiteID <-
  VegDatLong %>% group_by(SiteName, SiteType, SiteID, Species) %>%
  summarise(BasalArea = mean(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "BasalArea") %>%
  rename(`RedBasalArea` = "Red")%>%
   rename(`BlackBasalArea` = "Black") %>%
   rename(`WhiteBasalArea` = "White")%>%
  left_join(VegDatLong %>% group_by(SiteName, SiteType, SiteID, Species) %>%
  summarise(CanopyWidth = mean(`Canopy Width`[`Canopy Width`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "CanopyWidth") %>%
  rename(`RedCanopyWidth` = "Red")%>%
   rename(`BlackCanopyWidth` = "Black") %>%
   rename(`WhiteCanopyWidth` = "White"))%>%
  left_join(VegDatLong %>% group_by(SiteName, SiteType, SiteID, Species) %>%
  summarise(TreeHeight = mean(`Tree Height`[`Tree Height`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "TreeHeight") %>%
  rename(`RedTreeHeight` = "Red")%>%
   rename(`BlackTreeHeight` = "Black") %>%
   rename(`WhiteTreeHeight` = "White"))%>%
  mutate(across(.cols = everything(), ~ ifelse(is.infinite(.x), 0, .x)))%>%
  mutate(across(.cols = everything(), ~ ifelse(is.na(.x), 0, .x)))
  

VegMatrixIndependent <-
  VegDatLong %>%  group_by(SiteName, SiteType, Independent, Species) %>%
  summarise(BasalArea = mean(`Basal Area (m^2)`[`Basal Area (m^2)`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "BasalArea") %>%
  rename(`RedBasalArea` = "Red")%>%
   rename(`BlackBasalArea` = "Black") %>%
   rename(`WhiteBasalArea` = "White")%>%
  left_join(VegDatLong %>% group_by(SiteName, SiteType, Independent, Species) %>%
  summarise(CanopyWidth = mean(`Canopy Width`[`Canopy Width`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "CanopyWidth") %>%
  rename(`RedCanopyWidth` = "Red")%>%
   rename(`BlackCanopyWidth` = "Black") %>%
   rename(`WhiteCanopyWidth` = "White"))%>%
  left_join(VegDatLong %>% group_by(SiteName, SiteType, Independent, Species) %>%
  summarise(TreeHeight = mean(`Tree Height`[`Tree Height`!= 0] , na.rm = TRUE)) %>%
  pivot_wider(names_from = "Species", values_from = "TreeHeight") %>%
  rename(`RedTreeHeight` = "Red")%>%
   rename(`BlackTreeHeight` = "Black") %>%
   rename(`WhiteTreeHeight` = "White")) %>% filter(!is.na(Independent))%>%
  mutate(across(.cols = everything(), ~ ifelse(is.infinite(.x), 0, .x)))%>%
  mutate(across(.cols = everything(), ~ ifelse(is.na(.x), 0, .x)))

```

# Congruence

One big question is whether composition of birds and plants covary. Below, we use Mantel test and Procustes analsyes to evaluate if composition covaries. We will use both the raw data, by plot and the plots that are combined. 


```{r message=FALSE, error=FALSE, warning=FALSE}



TreeHeightBird <- 
  CongruenceCrossTaxon(DataVeg = VegMatrixSiteID%>% 
                         rename(Independent = SiteID) %>% filter(Independent %in% BirdDataOG$SiteID), 
                       BirdDataOG %>% select(-Independent)%>% rename(Independent = SiteID), 
                       ColTraitVeg = "TreeHeight") %>% arrange(Test)

TreeHeightBirdID <- 
  CongruenceCrossTaxon(VegMatrixIndependent, 
                       BirdData,   
                       ColTraitVeg = "TreeHeight") %>% arrange(Test)

BasalAreaBird <- 
  CongruenceCrossTaxon(VegMatrixSiteID%>% 
                         rename(Independent = SiteID) %>% filter(Independent %in% BirdDataOG$SiteID), 
                       BirdDataOG %>% select(-Independent)%>% rename(Independent = SiteID), 
                       ColTraitVeg = "BasalArea") %>% arrange(Test)

BasalAreaBirdID <- 
  CongruenceCrossTaxon(VegMatrixIndependent, 
                       BirdData, 
                       ColTraitVeg = "BasalArea") %>% arrange(Test)

CanopyWidthBird <- 
  CongruenceCrossTaxon(VegMatrixSiteID%>% 
                         rename(Independent = SiteID) %>% filter(Independent %in% BirdDataOG$SiteID), 
                       BirdDataOG %>% select(-Independent)%>% rename(Independent = SiteID), 
                       ColTraitVeg = "CanopyWidth") %>% arrange(Test)

CanopyWidthBirdID <- 
  CongruenceCrossTaxon(VegMatrixIndependent, 
                       BirdData, 
                       ColTraitVeg = "CanopyWidth") %>% arrange(Test)

```


As we see below, we get confilciting results when we use the combined data versus the raw data. This may be because we lack power to detcted an effect when the combine plots, and also because the plant compoisition varies amoung plots that are combined.




```{r view congruence mantel, echo=FALSE}

library(glue)

TreeHeightBirdID %>% filter(Group %in% c("Overall"))%>% 
       mutate(Type = "Tree Height")%>%
bind_rows(BasalAreaBirdID %>% filter(Group %in% c("Overall"))%>% mutate(Type = "Basal Area")) %>%
 bind_rows(CanopyWidthBirdID %>% filter(Group %in% c("Overall"))%>% mutate(Type = "Canopy Width"))%>%
  mutate(Significance = case_when(`P-Value`<0.001 ~ "***",
                                  `P-Value`<0.05 ~ "**",
                                  `P-Value`<0.1 ~ "*",
                                  TRUE ~ ""))%>%
 ggplot(aes(x = Type, y = Strength))+
  geom_bar(stat = "identity", position = "dodge")+
   scale_fill_viridis_d(option = "magma")+
  geom_text(aes(label = Significance), size = 6, position = position_dodge(width = .9))+
  facet_wrap(~Test)+
   theme_bw()+
  labs( y = expression(paste("Congruence (Procustes:", m^2, "; Mantel:r)")),
        x = "Plant Structure", fill = "")+
  theme(
    # X-axis title: no angle, all the way to the right
    axis.title.x = element_text(angle = 0, hjust = 1, vjust = 0),
    
    # Y-axis title: normal vertical orientation, all the way to the left
    axis.title.y = element_text(angle = 90, hjust = 1.25, vjust = 0),
    
    # Adjust plot margins to accommodate titles
    plot.margin = margin(t = 20, r = 20, b = 20, l = 20, unit = "pt")
  )


```

The results here are not reliable - we lack power to decct difefrencs. We will focus on our anlayses exploring differences overall, not be site type. 


Below, we see that using the procustes analayses, there is a evidence of congruence between birds and plants when we use basal areas as a proxy for pkant abunance, and this is for basin and fringe sites, as well as overall. 








```{r export congruence,  message=FALSE, error=FALSE, warning=FALSE}
png(paste0(here::here(), "/outputs/PlantBirdCongruenceMantelProcustes.png"),
    units = "in",
    res = 600, width = 8, height = 4)
TreeHeightBirdID %>% filter(Group %in% c("Overall"))%>% 
       mutate(Type = "Tree Height")%>%
bind_rows(BasalAreaBirdID %>% filter(Group %in% c("Overall"))%>% mutate(Type = "Basal Area")) %>%
 bind_rows(CanopyWidthBirdID %>% filter(Group %in% c("Overall"))%>% mutate(Type = "Canopy Width"))%>%
  mutate(Significance = case_when(`P-Value`<0.001 ~ "***",
                                  `P-Value`<0.05 ~ "**",
                                  `P-Value`<0.1 ~ "*",
                                  TRUE ~ ""))%>%
 ggplot(aes(x = Type, y = Strength))+
  geom_bar(stat = "identity", position = "dodge")+
   scale_fill_viridis_d(option = "magma")+
  geom_text(aes(label = Significance), size = 6, position = position_dodge(width = .9))+
  facet_wrap(~Test, scales = "free")+
   theme_bw()+
  labs( y = expression(paste("Congruence (Procustes:", m^2, "; Mantel:r)")),
        x = "Plant Structure", fill = "")+
  theme(
    # X-axis title: no angle, all the way to the right
    axis.title.x = element_text(angle = 0, hjust = 1, vjust = 0),
    
    # Y-axis title: normal vertical orientation, all the way to the left
    axis.title.y = element_text(angle = 90, hjust = 1, vjust = 0))
dev.off()


  
```
# Functional Disperson

To explore how bird composition is related to plants, we can build models exploring each plant species' abundance is predictive of bird:

* species richness
* funcitonal richness
* fuctional dispersion

We can use `dbFD` in the `FD` package to create these metrics, using a matrix of species abundances and binary traits. These are metrics I will pass on the courtney to build the models. 

```{r functional diversity, include=FALSE}
TB <- BirdData %>% ungroup() %>% arrange(Independent)%>% select(ANCH:ZEND) %>% as.data.frame()
rownames(TB) <- BirdData$Independent
BT <- BirdTraitsSpecies%>% arrange(Code) %>% select(Nectar:Migrant) %>% as.data.frame()
rownames(BT) <- BirdTraitsSpecies$Code
BirdFD <- FD::dbFD(BT, TB,
                    calc.FRic = T, calc.CWM = F, calc.FDiv =T)

write_csv(x = tibble(SiteName = BirdData %>% ungroup() %>% 
                       arrange(Independent)%>% select(SiteName) %>% reduce(c) ,
                 SiteType = BirdData %>% ungroup() %>% arrange(Independent)%>% select(SiteType)%>% reduce(c)  , 
                 Independent = str_remove_all(BirdData %>% ungroup() %>% arrange(Independent)%>% 
               select(Independent)%>% reduce(c), "-0")  ,
                 FunctionalDispersion = BirdFD$RaoQ, #Rao's quadratic entropy 
                 FunctionalRichness = BirdFD$FRic,
                 FunctionalEveness = BirdFD$FEve,
                 FunctionalDivergence = BirdFD$FDiv)%>%
            left_join(DiversityAlpha(BirdData%>%
                                       mutate(Independent = str_remove_all(Independent,  "-0")),
                                     "Independent", "ANCH", "ZEND")) %>%
            left_join(VegMatrixIndependent),
          file = paste0(here::here(), "/data/FunctionalDiversity.csv"))

rm(TB)
rm(BT)

```



```{r functional diversity, include=FALSE}
TB <- BirdDataOG %>% ungroup() %>% arrange(SiteID)%>% select(ANCH:ZEND) %>% as.data.frame()
rownames(TB) <- BirdDataOG$SiteID
BT <- BirdTraitsSpecies%>% arrange(Code) %>% select(Nectar:Migrant) %>% as.data.frame()
rownames(BT) <- BirdTraitsSpecies$Code
BirdFD <- FD::dbFD(BT, TB,
                    calc.FRic = T, calc.CWM = F, calc.FDiv =T)

write_csv(x = tibble(SiteName = BirdDataOG %>% ungroup() %>% 
                       arrange(SiteID)%>% select(SiteName) %>% reduce(c) ,
                 SiteType = BirdDataOG %>% 
                   ungroup() %>% arrange(SiteID)%>% select(SiteType)%>% reduce(c)  , 
                 SiteID = str_remove_all(BirdDataOG %>% ungroup() %>% arrange(SiteID)%>% 
               select(SiteID)%>% reduce(c), "-0")  ,
                 FunctionalDispersion = BirdFD$RaoQ, #Rao's quadratic entropy 
                 FunctionalRichness = BirdFD$FRic,
                 FunctionalEveness = BirdFD$FEve,
                 FunctionalDivergence = BirdFD$FDiv)%>%
            left_join(DiversityAlpha(BirdDataOG%>%
                                       mutate(SiteID = str_remove_all(SiteID, "-0")),
                                     "SiteID", "ANCH", "ZEND")) %>%
            left_join(VegMatrixSiteID),
          file = paste0(here::here(), "/data/FunctionalDiversityOG.csv"))

rm(TB)
rm(BT)

```




# Visulizing Communtiy Composiiton

Now, we can take a look at community composition using NMDSs for plants and look at how they might relate to the birds at the sites. After determining how many axis we need, which are 2, we can run our NMDS. 

```{r nmds numebr of axis, include=FALSE}
BasalAreaAxis <- 
NMDS.ScreePoints(data = VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("BasalArea")),
                 noRuns = 50)
CanopyWidthAxis <- 
NMDS.ScreePoints(data = VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("CanopyWidth")),
                 noRuns = 50)
TreeHeightAxis <- 
NMDS.ScreePoints(data = VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("TreeHeight")),
                 noRuns = 50)

```


```{r view nmds axis, message=FALSE, error=FALSE, warning=FALSE}
BasalAreaAxis  %>% t() %>% data.frame()%>%
  mutate(Run = factor(1:50))%>% 
  pivot_longer(!Run,
               names_to = c("NoAxis"),
               names_pattern = "X(.*)",
               values_to = "Stress")%>%
  group_by(NoAxis) %>%
  summarise(Stress = mean(Stress))%>%
  ungroup()%>%
  mutate(NoAxis = factor(as.numeric(as.character(NoAxis))))%>%
  ggplot(aes(x = NoAxis, y = Stress))+
  geom_line(aes(group = 1), size = 1)+
  theme_bw()
CanopyWidthAxis  %>% t() %>% data.frame()%>%
  mutate(Run = factor(1:50))%>% 
  pivot_longer(!Run,
               names_to = c("NoAxis"),
               names_pattern = "X(.*)",
               values_to = "Stress")%>%
  group_by(NoAxis) %>%
  summarise(Stress = mean(Stress))%>%
  ungroup()%>%
  mutate(NoAxis = factor(as.numeric(as.character(NoAxis))))%>%
  ggplot(aes(x = NoAxis, y = Stress))+
  geom_line(aes(group = 1), size = 1)+
  theme_bw()
TreeHeightAxis  %>% t() %>% data.frame()%>%
  mutate(Run = factor(1:50))%>% 
  pivot_longer(!Run,
               names_to = c("NoAxis"),
               names_pattern = "X(.*)",
               values_to = "Stress")%>%
  group_by(NoAxis) %>%
  summarise(Stress = mean(Stress))%>%
  ungroup()%>%
  mutate(NoAxis = factor(as.numeric(as.character(NoAxis))))%>%
  ggplot(aes(x = NoAxis, y = Stress))+
  geom_line(aes(group = 1), size = 1)+
  theme_gaea()
```


```{r run nmds, include=FALSE}



TreeHeightSiteIDNMS <- metaMDS(VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("TreeHeight")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)
BasalAreaSiteIDNMS <- metaMDS(VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("BasalArea")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)
CanopyWidthSiteIDNMS <- metaMDS(VegMatrixSiteID %>% arrange(SiteID)%>% 
                   ungroup() %>%select(contains("CanopyWidth")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)

TreeHeightIndependentNMS <- metaMDS(VegMatrixIndependent %>% arrange(Independent)%>% 
                   ungroup() %>%select(contains("TreeHeight")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)
BasalAreaIndependentNMS <- metaMDS(VegMatrixIndependent %>% arrange(Independent)%>% 
                   ungroup() %>%select(contains("BasalArea")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)
CanopyWidthIndependentNMS <- metaMDS(VegMatrixIndependent %>% arrange(Independent)%>% 
                   ungroup() %>%select(contains("CanopyWidth")),
                                       distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)

```


```{r save the plots, include = FALSE, message=FALSE, error=FALSE, warning=FALSE}
BirdsSiteNMS <- metaMDS(BirdData %>% ungroup() %>% select(ANCH:ZEND) ,  distance = "bray",
                                 k = 2, autotransform = TRUE,trymax=100)
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-Combined",
                 DataX =  BirdData,
                 Choices = c(1:2),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Site")
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-Combined",
                 DataX =  BirdData,
                 Choices = c(1:2),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Type")

BirdsSiteNMS <- metaMDS(BirdDataOG %>% ungroup() %>% select(ANCH:ZEND) ,  distance = "bray",
                                 k = 3, autotransform = TRUE,trymax=100)
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-OG",
                 DataX =  BirdDataOG,
                 Choices = c(1:3),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Site")
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-OG",
                 DataX =  BirdDataOG,
                 Choices = c(1:3),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Type")

BirdsSiteNMS <- metaMDS(BirdDataSumSiteID %>% ungroup() %>% select(ANCH:ZEND) ,  distance = "bray",
                                 k = 3, autotransform = TRUE,trymax=100)
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-OG-Date-Sum",
                 DataX =  BirdDataSumSiteID,
                 Choices = c(1:3),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Site")
NMDSPlotsBirds(NMDSList = BirdsSiteNMS,
                 FileNames = "Abundance-OG-Date-Sum",
                 DataX =  BirdDataSumSiteID,
                 Choices = c(1:3),
                 Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                 Type = "Type")

BirdsPlantsNMDSSitePlots <-
  NMDSPlotsBirdsPlants(NMDSList = list(`Basal Area`= (BasalAreaIndependentNMS),
                                     `Canopy Width`= CanopyWidthIndependentNMS,
                                     `Tree Height`= TreeHeightIndependentNMS),
                     DataX = BirdDataSum,
                     DataY = list(BirdDataSum, BirdDataSum),
                     Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                     Type = "Site")
PlantsNMDSSitePlots <-
NMDSPlotsPlants(NMDSList = list(`Basal Area`= (BasalAreaSiteIDNMS),
                                     `Canopy Width`= CanopyWidthSiteIDNMS,
                                     `Tree Height`= TreeHeightSiteIDNMS),
                     DataX = VegMatrixSiteID,
                     Type = "Site")

BirdsPlantsNMDSTypePlots <-
  NMDSPlotsBirdsPlants(NMDSList = list(`Basal Area`= (BasalAreaIndependentNMS),
                                     `Canopy Width`= CanopyWidthIndependentNMS,
                                     `Tree Height`= TreeHeightIndependentNMS),
                     DataX = VegMatrixIndependent,
                     DataY = list(BirdDataSum, BirdDataSum),
                     Group = c("Species", "Food", "Behaviour",  "Nesting", "Habitat","Type"),
                     Type = "Type")

PlantsNMDSTypePlots <-
NMDSPlotsPlants(NMDSList = list(`Basal Area`= (BasalAreaSiteIDNMS),
                                     `Canopy Width`= CanopyWidthSiteIDNMS,
                                     `Tree Height`= TreeHeightSiteIDNMS),
                     DataX = VegMatrixSiteID,
                     Type = "Type")

```

# Dispersion

## Birds

```{r permanova birds, message=FALSE, error=FALSE, warning=FALSE}

DispersionResults(DataX = BirdDataOG %>%  
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "Birds", groups = "SiteType")
DispersionPlots(DataX = BirdDataOG %>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "Birds", groups =  "SiteType")



```

## Birds

```{r permanova birds traits, message=FALSE, error=FALSE, warning=FALSE}


    
DispersionResults(DataX = BirdTraitsOG%>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "Traits", groups = "SiteType")
DispersionPlots(DataX = BirdTraitsOG%>% 
                 # mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                  mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")),
                DataType = "Traits", groups = "SiteType")




```


## Plants

### Basal Area

```{r permanova BasalArea, message=FALSE, error=FALSE, warning=FALSE}

DispersionResults(DataX = VegMatrixSiteID%>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "BasalArea", groups = "SiteType")
DispersionPlots(DataX = VegMatrixSiteID%>% 
                  #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                  mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")),
                DataType = "BasalArea", groups = "SiteType")



```



```{r permanova CanopyWidth, message=FALSE, error=FALSE, warning=FALSE}

DispersionResults(DataX = VegMatrixSiteID%>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "CanopyWidth", groups = "SiteType")
DispersionPlots(DataX = VegMatrixSiteID%>% 
                  #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                  mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")),
                DataType = "CanopyWidth", groups = "SiteType")



```

### Tree Height

```{r permanova TreeHeight, message=FALSE, error=FALSE, warning=FALSE}

DispersionResults(DataX = VegMatrixSiteID%>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "TreeHeight", groups = "SiteType")
DispersionPlots(DataX = VegMatrixSiteID%>% 
                  #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                  mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")),
                DataType = "TreeHeight", groups = "SiteType")



```

### Canopy Width

```{r permanova CanopyWidth, message=FALSE, error=FALSE, warning=FALSE}

DispersionResults(DataX = VegMatrixSiteID%>% 
                    #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                    mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")), 
                  DataType = "CanopyWidth", groups = "SiteType")
DispersionPlots(DataX = VegMatrixSiteID%>% 
                  #mutate(SiteType = ifelse(SiteName == "Westerhall", "Both", SiteType))%>%
                  mutate(SiteName  = paste0(SiteName, "\n(", SiteType, ")")),
                DataType = "CanopyWidth", groups = "SiteType")



```


## Stable Isotopes

```{r}
png(paste0(here::here(), "/outputs/StableIsotopes.png"),
      width = 8, height = 5, res = 600, units = "in", bg = "white")
 read_excel(paste0(here::here(), "/data/2019 Grenada isotopes.xlsx"))%>%
  mutate(Group = ifelse(str_detect(Type, "plant"), "Plant", "Water"))%>%
  mutate(Sample = case_when(str_detect(Sample, "pond") ~ "Pond",
                            TRUE ~ Sample) %>% str_to_title())%>%
  mutate(SiteType = ifelse(str_detect(Site, "Levera|Conf"), "Basin", "Fringe"))%>%
  mutate(Group2 = case_when(str_detect(Sample, "Red|Black|Buttonwood|White") ~ Sample,
                            TRUE ~ "Water"))%>%
  ggplot(aes(x = `18O`, y = `2H`, shape = Group2, color = Group2))+
  geom_point(size = 5)+
  #geom_text_repel()+
  facet_wrap(~ SiteType)+
   labs(x = expression(paste( δ^18, "O")), y = expression(paste( δ^2, "H")))+
scale_fill_viridis_d(option = "magma")+
      scale_color_viridis_d(option = "magma")+
      theme_bw()+
      theme(
        # X-axis title: no angle, all the way to the right
        axis.title.x = element_text(angle = 0, hjust = 1, vjust = 0),
        
        # Y-axis title: normal vertical orientation, all the way to the left
        axis.title.y = element_text(angle = 90, hjust = 1, vjust = 0),
        
        legend.position = "bottom")+
  labs(shape = "", color = "")
  
  dev.off()
  
  


```



## Mammals



```{r}

library(readxl)
library(dplyr)
library(lubridate)
library(unmarked)

# Read the Excel file
dataMammals <-  read_csv(paste0(here::here(), "/data/PredatorDataForR.csv")) %>% 
  mutate(HitTimeDate = lubridate::as_datetime(paste0(as.Date(DateOfHit, "%m/%d/%y"), " ", Time))) %>% 
  mutate_at(vars(starts_with("Date")), ~as.Date(., "%m/%d/%y")) %>% relocate(HitTimeDate, .after = DateOfHit)


dataMammalsGrid <- 
  expand_grid(
  Site = unique(dataMammals$Site),
  Camera = unique(dataMammals$Camera),
  Date = seq(min(dataMammals$DateOfHit), max(dataMammals$DateOfHit), by = "day"))%>%
  left_join(dataMammals %>%  mutate(Species = ifelse(str_detect(Species, "Rat|rat"), "Brown Rat", Species)) %>%
              group_by(Site, Camera, DateOfHit, Species)%>%  tally() %>% pivot_wider(names_from = Species, values_from = n, values_fill = 0)%>%
              ungroup() %>% rename(Date = DateOfHit))%>%
   mutate(across(where(is.numeric), ~ ifelse(replace_na(., 0)>1,1,0)))


SaveModelsOccupance<-
map(c("Brown Rat", "Cat", "Dog"), function(i){
  
dataShifted<- 
  dataMammalsGrid %>% select(Site, Camera, Date, !!sym(i)) %>% pivot_wider(names_from = Date, values_from = !!sym(i))

unmarkedData <- unmarkedFrameOccu(y = dataShifted %>% select(-(1:2)) %>% as.matrix(), siteCovs = dataShifted %>% select(1:2))


# Fit occupancy model
model1 <- occu(~ 1 ~ 1, data = unmarkedData)
model2 <- occu(~ 1 ~ Site, data = unmarkedData)

list(Null = model1,
     Site = model2)
})

```

```{r}
png(paste0(here::here(), "/outputs/MammalDetections.png"),
      width = 8, height = 5, res = 600, units = "in", bg = "white")
 dataMammals %>%  mutate(Species = ifelse(str_detect(Species, "Rat|rat"), "Brown Rat", Species)) %>%
    group_by(Site, Species)%>%  tally()%>%
  ggplot(aes( y = n, x = Site, fill = Species))+
  geom_bar(position = "dodge", stat = "identity")+
  scale_fill_viridis_d(option = "magma")+
      scale_color_viridis_d(option = "magma")+
      theme_bw()+
      theme(
        # X-axis title: no angle, all the way to the right
        axis.title.x = element_text(angle = 0, hjust = 1, vjust = 0),
        
        # Y-axis title: normal vertical orientation, all the way to the left
        axis.title.y = element_text(angle = 90, hjust = 1, vjust = 0),
        
        legend.position = "bottom")+
  labs(shape = "", color = "", fill = " ", y = "Number of Detections")
  dev.off()

```


```{r message=FALSE, error=FALSE, warning=FALSE}
write_xlsx(x = list(`Plants - Independent (Mean)` = VegMatrixIndependent,
                    `Plants - SiteID (Mean)` = VegMatrixSiteID,
                    `Birds - Mean by Independent` = BirdData,
                    `Birds - Sum by Independent` = BirdDataSum,
                     `Birds - Sum by Date & Independent` = BirdDatDateSum),
           path = paste0(here::here(), "/data/DataFromCongruenceAnalyses.xlsx"))
```
